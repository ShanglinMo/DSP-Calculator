<!DOCTYPE html>
<html style="background-image: url('assets/bg.png'); background-attachment: fixed;">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>dsp</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600,700">
    <link rel="stylesheet" href="assets/css/styles.min.css">
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-W2STQT8FQE"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-W2STQT8FQE');
    </script>
</head>

<body style="background-color: transparent">
    <div style="background: #1f2439; max-width:1280px; margin-top:32px; margin-bottom:36px; margin-left:auto; margin-right:auto; padding:32px; padding-bottom:120px;border-radius:12px;box-shadow: rgba(255, 255, 255, 0.1) 0px 1px 1px 0px inset, rgba(50, 50, 93, 0.25) 0px 50px 100px -20px, rgba(0, 0, 0, 0.3) 0px 30px 60px -30px;">
        <div class="container" style="text-align: center;">
            <div style="padding: 0;"></div>
        </div>
        <div class="highlight-clean">
            <div class="container">
                <div class="intro">
                    <h2 id="title" class="text-center" style="color: #cbfaff;text-shadow: 0px 0px 6px #90fbfe;font-weight: 600;font-family: Inter, sans-serif;">DSP计算器</h2>
                    <p id="subtitle" class="text-center" style="color: rgb(208,250,254);">
                        合理规划布局，防变太空垃圾   -   By Marcus, Ricky
                    </p>
                    
                </div>
                <div class="buttons"></div>
            </div>
        </div>
        <div>
            <div class="container">
                <div class="row">
                    <div class="col-md-4" style="margin-bottom: 8px;"><select id="targetItems" style="width: 100%;color: #A9F7FD;font-family: Inter, sans-serif;font-weight: normal;border-color: #A9F7FD;border-radius: 4px;background: rgba(169,247,253,0.18);height: 36px;font-size: 14px;min-width: 100%;max-width: 100%;" autofocus="">
                            <option value="undefined">选择一件物品</option>
                        </select>
                    </div>
                    <div class="col-md-4" style="margin-bottom: 8px;">
                        <input id="quantity_input" type="number" style="width: 100%;background: rgba(169,247,253,0.18);border: 1px solid #A9F7FD;border-radius: 4px;height: 36px;color: #A9F7FD;font-size: 14px;font-weight: normal;font-family: Inter, sans-serif;" placeholder="数量">
                    </div>
                    <div class="col-md-4"><select id="productRate" style="width: 100%;color: #A9F7FD;font-family: Inter, sans-serif;font-weight: normal;border-color: #A9F7FD;border-radius: 4px;background: rgba(169,247,253,0.18);height: 36px;font-size: 14px;min-width: 100%;max-width: 100%;">
                            <option id="rate_option" value="/m" selected="">每分钟</option>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12" style="text-align: center;margin: 0px;margin-right: 0px;margin-left: 0px;margin-top: 24px;margin-bottom: 0px;">
                        <button id="calculate_button" onClick=calculate() class="btn btn-primary" type="button" style="margin-right: 2px; margin-left: 2px; margin-bottom: 8px; color: #1C2031;font-size: 14px;border-radius: 4px;border-style: solid;border-color: #a9f7fdef;background: #a9f7fdef;height: 42px;text-align: center;width: 100px;">计算</button>
                        <button id="settings_button" data-toggle="collapse" data-target="#recipe-settings" class="btn btn-primary" type="button" style="margin-left: 2px; margin-bottom: 8px; color: #A9F7FD;font-size: 14px;border-radius: 4px;border-style: solid;border-color: #A9F7FD;background: rgba(169,247,253,0.18);height: 42px;text-align: center;width: 100px;">设置</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="table-responsive collapse" id="recipe-settings" style="margin-top: 8px;color: #90F5FB;border-radius: 4px;">
                            <table id="" class="table" style="margin-bottom: 0px">
                                <tbody>
                                    <tr>
                                        <td id="placeholder_cell"> 正在加班做 </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="table-responsive" style="margin-top: 48px;color: #90F5FB;border-radius: 4px;">
                            <table id="resultTable1" class="table" style="margin-bottom: 0px">
                                <tbody>
                                    <tr>
                                        <td id="icon_cell1" style="color: #90f6fbcb !important; border-color: #90f6fbcb !important;">图标</td>
                                        <td id="items_required_cell" style="color: #90f6fbcb !important; border-color: #90f6fbcb !important;">需要物品</td>
                                        <td id="quantities_required_cell" style="color: #90f6fbcb !important; border-color: #90f6fbcb !important;">需要产量</td>
                                        <td id="buildings_required_cell" style="color: #90f6fbcb !important; border-color: #90f6fbcb !important;">需要生产建筑</td>
                                        <td id="buildings_quantity_required_cell" style="color: #90f6fbcb !important; border-color: #90f6fbcb !important;">需要生产建筑数量</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="table-responsive" style="margin-top: 12px;color: #90F5FB;border-radius: 4px;">
                            <table id="resultTable2" class="table" style="margin-bottom: 0px">
                                <tbody>
                                    <tr>
                                        <td id="icon_cell2">图标</td>
                                        <td id="raw_required_cell">需要原始资源</td>
                                        <td id="raw_sites_required_cell">需要开采数量</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <p class="text-center" style="color: rgb(208,250,254);">
        <a class="text-center" href="javascript:updateLanguage('en');" style="color: rgb(208,250,254);">&nbsp;English&nbsp;</a>
        <a class="text-center" href="javascript:updateLanguage('cn');" style="color: rgb(208,250,254);">&nbsp;简体中文&nbsp;</a>
        <a class="text-center" href="https://github.com/ShanglinMo/dysonSphereProgramCalculator" style="color: rgb(208,250,254);">&nbsp;GitHub&nbsp;</a>
    </p>
    
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/script.min.js"></script>
    <script src="node.js"></script>
</body>

<script>

/* update when user visits */
var currentLanguage = String(navigator.language || navigator.userLanguage).toLowerCase()

/* recipe -> item -> recipes */
var recipeList
var supChain
recipeList = loadRecipes()
trans = loadTrans()
updateLanguage(currentLanguage)
console.log("Browser language is: " + currentLanguage)

/* language switcher */
function updateLanguage(targetLanguage) {
    trans = loadTrans()
    if (targetLanguage.includes('cn')) {
        currentLanguage = "cn"
    }
    else { // if (targetLanguage.includes('en')) {
        currentLanguage = "en"
    }
    addTargetItems()
    cleanTable()
    document.getElementById('title').innerHTML = trans['title'][currentLanguage]
    document.getElementById('subtitle').innerHTML = trans['subtitle'][currentLanguage]
    document.getElementById('quantity_input').placeholder = trans['quantity_input'][currentLanguage]
    document.getElementById('rate_option').innerHTML = trans['rate_option'][currentLanguage]
    document.getElementById('quantity_input').placeholder = trans['quantity_input'][currentLanguage]
    document.getElementById('calculate_button').innerHTML = trans['calculate_button'][currentLanguage]
    document.getElementById('settings_button').innerHTML = trans['settings_button'][currentLanguage]
    document.getElementById('placeholder_cell').innerHTML = trans['placeholder_cell'][currentLanguage]
    document.getElementById('icon_cell1').innerHTML = trans['icon_cell1'][currentLanguage]
    document.getElementById('icon_cell2').innerHTML = trans['icon_cell2'][currentLanguage]
    document.getElementById('items_required_cell').innerHTML = trans['items_required_cell'][currentLanguage]
    document.getElementById('quantities_required_cell').innerHTML = trans['quantities_required_cell'][currentLanguage]
    document.getElementById('buildings_required_cell').innerHTML = trans['buildings_required_cell'][currentLanguage]
    document.getElementById('buildings_quantity_required_cell').innerHTML = trans['buildings_quantity_required_cell'][currentLanguage]
    document.getElementById('raw_required_cell').innerHTML = trans['raw_required_cell'][currentLanguage]
    document.getElementById('raw_sites_required_cell').innerHTML = trans['raw_sites_required_cell'][currentLanguage]
}
console.log("Current language is: " + currentLanguage)

function loadRecipes(){
    var json = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': "data/itemInfo_EN.json",
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })(); 
    return json.recipe
}

function loadTrans(){
    var json = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': "data/trans.json",
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })(); 
    return json
}

function makeChain(item, amount){
    var parent = new Node(item, amount, recipeList)
    for(var n=0;n<recipeList[item].recipes.length;n++){
            var factor = amount / recipeList[item].recipes[n].production_speed
            parent.factory = [recipeList[item].recipes[n].made_in, Math.ceil(factor)]
            var igd = recipeList[item].recipes[n].ingredients
            if(recipeList[item].recipes[n].end){
                for(var i=0;i<igd.length;i++){
                    parent.ingredients[n][i] = new Node(igd[i].name, igd[i].amount*factor, recipeList)
                    parent.ingredients[n][i].amount = Math.ceil(parent.ingredients[n][i].amount)
                }
            } else {
                for(var i=0;i<igd.length;i++){
                var child = makeChain(igd[i].name, igd[i].amount*factor)
                parent.ingredients[n][i] = child
                }
            }
        } 
    return parent 
}

/* add items to <select> */
function addTargetItems() {
    var select = document.getElementById("targetItems")
    $("#targetItems").empty();
    var option = document.createElement("option")
    option.text = trans['choose_target_item'][currentLanguage]
    select.add(option)
    var names = Object.keys(recipeList)
    var i
    for (i = 0; i < names.length; i++) {
        var option = document.createElement("option")
        option.text = trans[names[i]][currentLanguage]
        option.value = names[i]
        select.add(option)
    }
}

/* clean table */
function cleanTable() {
    var theTable = document.getElementById("resultTable1");
    var rowsToDelete = theTable.rows.length
    var x
    for(x = 1; x < rowsToDelete; x++) {
        theTable.deleteRow(1)
    }
    var theTable = document.getElementById("resultTable2");
    var rowsToDelete = theTable.rows.length
    var x
    for(x = 1; x < rowsToDelete; x++) {
        theTable.deleteRow(1)
    }
}

/* calculate */ 
function calculate() {
    /* clean table */
    cleanTable()
    /* get target item */ 
    var select = document.getElementById("targetItems")
    var targetItem = select.options[select.selectedIndex].value
    /* get target quantity */ 
    var targetQuantity = document.getElementById("quantity_input").value;
    /* make chain */ 
    supplyChain = makeChain(targetItem, targetQuantity)
    console.log(supplyChain)
    bfs_sum(supplyChain.ingredients)

    /* insert row */
    function insertRow(node) {
        cell1 = trans[node.item][currentLanguage]
        if (!node.item.includes("vein")) { node.amount = Math.round(node.amount); }
        var table1 = document.getElementById("resultTable1").tBodies[0]
        var table2 = document.getElementById("resultTable2").tBodies[0]
        if (node.factory == undefined) {
            var row = table2.rows[0].cloneNode(true)
            row.cells[0].innerHTML = "<img style='max-width:2.5rem;max-height:2.5rem;' src='icon/" + node.item + ".png'/>"
            row.cells[1].innerHTML = cell1
            row.cells[2].innerHTML = node.amount // + " " + document.getElementById("productRate").value
            // row.cells[3].innerHTML = "正在加班做"
            // row.cells[4].innerHTML = "正在加班做"
            table2.appendChild(row);
        }
        else { 
            var row = table1.rows[0].cloneNode(true)
            row.cells[0].innerHTML = "<img style='max-width:2.5rem;max-height:2.5rem;' src='icon/" + node.item + ".png'/>"
            row.cells[1].innerHTML = cell1
            row.cells[2].innerHTML = node.amount // + " " + document.getElementById("productRate").value
            row.cells[3].innerHTML = "<img style='max-width:2.5rem;max-height:2.5rem;' src='icon/" + node.factory[0] + ".png'/>"
            row.cells[4].innerHTML = node.factory[1]
            table1.appendChild(row);
        }
    }

    /* bfs to add all ingredients */
    function bfs_separate(ingredients) {
        // if there is nothing, return false
        if (ingredients == null) {
            return false
        }
        // start a new Queue
        const queue = [];
        // add root to queue
        ingredients[0].forEach(child => queue.push(child));
        // while queue is not empty
        while (queue.length !== 0) {
            if (queue[0].ingredients != null) {
                // get TreeNode Children
                const nodeChildren = queue[0].ingredients[0];
                // if node has children, loop and add each to queue
                if (nodeChildren.length !== 0) {
                    nodeChildren.forEach(child => queue.push(child));
                }
            }
            insertRow(queue[0]) // print the first node
            // remove first node from queue
            queue.shift();
        }
    }

    /* bfs to add all ingredients, and auto sum the amount */
    function bfs_sum(ingredients) {
        // if there is nothing, return false
        if (ingredients == null) {
            return false
        }
        // queue and out
        const queue = [];
        const out = [];
        // add root to queue
        ingredients[0].forEach(child => queue.push(child));
        // while queue is not empty
        while (queue.length !== 0) {
            if (queue[0].ingredients != null) {
                // get TreeNode Children
                const nodeChildren = queue[0].ingredients[0];
                // if node has children, loop and add each to queue
                if (nodeChildren.length !== 0) {
                    nodeChildren.forEach(child => queue.push(child));
                }
            }
            // extract the node
            out.push(queue[0])
            // remove first node from queue
            queue.shift();
        }
        // merge forward
        const out_merged = []

        var i
        for (i = out.length - 1; i >= 0; i--) { 
            var found = 0  
            var j
            for (j = 0; j < out_merged.length; j++) { 
                if (out[i].item === out_merged[j].item) {
                    out_merged[j].amount += out[i].amount // merge
                    found = 1
                    break
                }
            }
            if (found == 0) {
                out_merged.push(out[i]) // add
            }
        }
        out_merged.reverse()
        out_merged.forEach(child => insertRow(child));
    }
}

</script>
</html>