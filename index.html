<!DOCTYPE html>
<html style="background: #1f2439;">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>dsp</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Inter:400,500,600,700">
    <link rel="stylesheet" href="assets/css/styles.min.css">
</head>

<body style="background: rgba(255,255,255,0);">
    <div class="container" style="text-align: center;">
        <div style="padding: 0;"></div>
    </div>
    <div class="highlight-clean">
        <div class="container">
            <div class="intro">
                <h2 class="text-center" style="color: #cbfaff;text-shadow: 0px 0px 6px #90fbfe;font-weight: 600;font-family: Inter, sans-serif;">戴森球计划计算器</h2>
                <p class="text-center" style="color: rgb(208,250,254);">算点东西吧老板</p>
            </div>
            <div class="buttons"></div>
        </div>
    </div>
    <div>
        <div class="container">
            <div class="row">
                <div class="col-md-4" style="margin-bottom: 8px;"><select id="targetItems" style="width: 100%;color: #A9F7FD;font-family: Inter, sans-serif;font-weight: normal;border-color: #A9F7FD;border-radius: 4px;background: rgba(169,247,253,0.18);height: 36px;font-size: 14px;min-width: 100%;max-width: 100%;" autofocus="">
                        <option value="undefined">选择一件物品</option>
                    </select></div>
                <div class="col-md-4" style="margin-bottom: 8px;"><input type="number" id="targetQuantity" style="width: 100%;background: rgba(169,247,253,0.18);border: 1px solid #A9F7FD;border-radius: 4px;height: 36px;color: #A9F7FD;font-size: 14px;font-weight: normal;font-family: Inter, sans-serif;" placeholder="数量"></div>
                <div class="col-md-4"><select id="productRate" style="width: 100%;color: #A9F7FD;font-family: Inter, sans-serif;font-weight: normal;border-color: #A9F7FD;border-radius: 4px;background: rgba(169,247,253,0.18);height: 36px;font-size: 14px;min-width: 100%;max-width: 100%;">
                        <option value="" selected="">每分钟</option>
                    </select></div>
            </div>
            <div class="row">
                <div class="col-md-12" style="text-align: center;margin: 0px;margin-right: 0px;margin-left: 0px;margin-top: 24px;margin-bottom: 0px;">
                    <button onClick=calculate() class="btn btn-primary" type="button" style="color: #A9F7FD;font-size: 14px;border-radius: 4px;border-style: solid;border-color: #A9F7FD;background: rgba(169,247,253,0.18);height: 42px;text-align: center;width: 100px;">计算</button></div>
            </div>
            <div class="row">
                <div class="col">
                    <div class="table-responsive" style="margin-top: 48px;color: #90F5FB;border-radius: 4px;border: 1px solid #90F5FB ;">
                        <table id="resultTable" class="table" style="margin-bottom: 0px">
                            <tbody>
                                <tr >
                                    <td style="color: #90F5FB;border-color: #90F5FB;">图标</td>
                                    <td style="color: #90F5FB;border-color: #90F5FB;">需要物品</td>
                                    <td style="color: #90F5FB;border-color: #90F5FB;">需要数量</td>
                                    <td style="color: #90F5FB;border-color: #90F5FB;">生产建筑</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <script src="assets/js/script.min.js"></script>
    <script src="node.js"></script>
</body>

<script>

var recipeList
var supChain

function loadRecipes(){
    var json = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': "data/itemInfo_EN.json",
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })(); 
    return json.recipe
}

function loadTrans(){
    var json = (function () {
        var json = null;
        $.ajax({
            'async': false,
            'global': false,
            'url': "data/trans.json",
            'dataType': "json",
            'success': function (data) {
                json = data;
            }
        });
        return json;
    })(); 
    return json
}

function makeChain(item, amount){
    var parent = new Node(item, amount, recipeList)
    for(var n=0;n<recipeList[item].recipes.length;n++){
            var factor = amount / recipeList[item].recipes[n].production_speed
            var igd = recipeList[item].recipes[n].ingredients
            if(recipeList[item].recipes[n].end){
                for(var i=0;i<igd.length;i++){
                    parent.ingredients[n][i] = new Node(igd[i].name, igd[i].amount*factor, recipeList)
                }
            } else {
                for(var i=0;i<igd.length;i++){
                var child = makeChain(igd[i].name, igd[i].amount*factor)
                parent.ingredients[n][i] = child
                }
            }
        } 
    return parent 
}

/* recipe -> item -> recipes */
recipeList = loadRecipes()
trans = loadTrans()
document.getElementById("productRate").disabled = true;
addTargetItems()

/* add items to <select> */
function addTargetItems() {
    var select = document.getElementById("targetItems")
    var names = Object.keys(recipeList)
    var i
    for (i = 0; i < names.length; i++) {
        var option = document.createElement("option")
        option.text = trans[names[i]]
        option.value = names[i]
        select.add(option)
    }
}

/* calculate */ 
function calculate() {
    /* clean table */
    var theTable = document.getElementById("resultTable");
    var rowsToDelete = theTable.rows.length
    var x
    for(x = 1; x < rowsToDelete; x++) {
        theTable.deleteRow(1)
    }
    /* get target item */ 
    var select = document.getElementById("targetItems")
    var targetItem = select.options[select.selectedIndex].value
    /* get target quantity */ 
    var targetQuantity = document.getElementById("targetQuantity").value;
    /* make chain */ 
    supplyChain = makeChain(targetItem, targetQuantity)
    bfs_sum(supplyChain.ingredients)

    /* insert row */
    function insertRow(node) {
        cell1 = trans[node.item]
        if (!node.item.includes("vein")) { node.amount = Math.round(node.amount); }
        var table = document.getElementById("resultTable").tBodies[0]
        var row = table.rows[0].cloneNode(true)
        row.cells[0].innerHTML = "<img style='max-width:3rem;max-height:3rem;' src='icon/" + node.item + ".png'/>"
        row.cells[1].innerHTML = cell1
        row.cells[2].innerHTML = node.amount
        row.cells[3].innerHTML = node.made_in
        table.appendChild(row);
    }

    /* bfs to add all ingredients */
    function bfs_separate(ingredients) {
        // if there is nothing, return false
        if (ingredients == null) {
            return false
        }
        // start a new Queue
        const queue = [];
        // add root to queue
        ingredients[0].forEach(child => queue.push(child));
        // while queue is not empty
        while (queue.length !== 0) {
            if (queue[0].ingredients != null) {
                // get TreeNode Children
                const nodeChildren = queue[0].ingredients[0];
                // if node has children, loop and add each to queue
                if (nodeChildren.length !== 0) {
                    nodeChildren.forEach(child => queue.push(child));
                }
            }
            insertRow(queue[0]) // print the first node
            // remove first node from queue
            queue.shift();
        }
    }

    /* bfs to add all ingredients, and auto sum the amount */
    function bfs_sum(ingredients) {
        // if there is nothing, return false
        if (ingredients == null) {
            return false
        }
        // queue and out
        const queue = [];
        const out = [];
        // add root to queue
        ingredients[0].forEach(child => queue.push(child));
        // while queue is not empty
        while (queue.length !== 0) {
            if (queue[0].ingredients != null) {
                // get TreeNode Children
                const nodeChildren = queue[0].ingredients[0];
                // if node has children, loop and add each to queue
                if (nodeChildren.length !== 0) {
                    nodeChildren.forEach(child => queue.push(child));
                }
            }
            // extract the node
            out.push(queue[0])
            // remove first node from queue
            queue.shift();
        }
        // merge forward
        const out_merged = []

        var i
        for (i = 0; i < out.length; i++) { 
            var found = 0  
            var j
            for (j = 0; j < out_merged.length; j++) { 
                console.log(out_merged[j])
                if (out[i].item === out_merged[j].item && out_merged[j].item != undefined) {
                    out_merged[j].amount += out[i].amount // merge
                    found = 1
                    break
                }
            }
            if (found == 0) {
                out_merged.push(out[i]) // add
            }
        }
        out_merged.forEach(child => insertRow(child));
    }
}

</script>
</html>